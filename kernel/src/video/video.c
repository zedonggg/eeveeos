#include "video.h"
#include "../utils/utils.h"
#include "../limine.h"

__attribute__((used, section(".limine_requests")))
static volatile struct limine_framebuffer_request framebuffer_request = {
    .id = LIMINE_FRAMEBUFFER_REQUEST,
    .revision = 0
};

struct flanterm_context *ft_ctx = NULL;

static void hcf(void) {
    for (;;) {
        asm ("hlt");
    }
}

void init_video() {
    if (framebuffer_request.response == NULL 
        || framebuffer_request.response->framebuffer_count < 1) {
            hcf();
    }

    struct limine_framebuffer *framebuffer = framebuffer_request.response->framebuffers[0];

    ft_ctx = flanterm_fb_init(
        NULL,
        NULL,
        framebuffer->address, framebuffer->width, framebuffer->height, framebuffer->pitch,
        framebuffer->red_mask_size, framebuffer->red_mask_shift,
        framebuffer->green_mask_size, framebuffer->green_mask_shift,
        framebuffer->blue_mask_size, framebuffer->blue_mask_shift,
        NULL,
        NULL, NULL,
        NULL, NULL,
        NULL, NULL,
        NULL, 0, 0, 1,
        0, 0,
        0
    );

    const char* osTitle[] = {
        "███████╗███████╗██╗   ██╗███████╗███████╗ ██████╗ ███████╗",
        "██╔════╝██╔════╝██║   ██║██╔════╝██╔════╝██╔═══██╗██╔════╝",
        "█████╗  █████╗  ██║   ██║█████╗  █████╗  ██║   ██║███████╗",
        "██╔══╝  ██╔══╝  ╚██╗ ██╔╝██╔══╝  ██╔══╝  ██║   ██║╚════██║",
        "███████╗███████╗ ╚████╔╝ ███████╗███████╗╚██████╔╝███████║",
        "╚══════╝╚══════╝  ╚═══╝  ╚══════╝╚══════╝ ╚═════╝ ╚══════╝",
        NULL
    };


    const char* osArt[] = {
        "             ▒▒                                                                           ",
        "             ▒▓░                                                                          ",
        "            ░▒▒▓▒░                                                                        ",
        "            ░▒░░▓▒░                                                                       ",
        "            ▒░░░░▒▒░                                                                      ",
        "           ░▒░░░░░▓▒▒                                                                     ",
        "            ▒▒░░░░░▒▒░                                                                    ",
        "            ▒▒░░░░░░▒▒                                                                    ",
        "            ░▒░░░░░░▒▓▒                                                                   ",
        "             ▒░░░░░░░▒▒░                                                                  ",
        "             ▒▒░░░░░░░▓▒          ░                          ░░░░▒▒▓▓▓▓▒░                 ",
        "             ░▒▒░░░░░░▒▒░░░░▒▓▒░░ ▓▓▒                ░░▒▒▒▓▓▒▒▒▒░░░░▒▒░                   ",
        "              ░▒▒░░░░░░▒░░▓▓▓▓▓▓▓▓▓▓▓░▒░          ▒▓▓▓▒░░░░░░░░░░░░▒▒░                    ",
        "                ▒▒░░░░░▓░▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▒▓░    ░▒▓▒░░░░░░░░░░░░░░▒▒░                      ",
        "                 ░▒▒░░▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓░ ░▒▓▒░░░░░░░░░░░░░░▒▒░         ░▒             ",
        "                   ░▒▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▒▓░░░░░░░░░░░░░░░▒▓▒         ░▓▓▓▒            ",
        "                    ░▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▒▒▒░░░░░░░░░░░▒▓▒░         ░▒▓██▓░            ",
        "                   ░▒▓▓▓▓▓▓▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▒░░░░░▒▒▒▒▓▒▒░         ▒▓▓████▓▒            ",
        "                   ▒▒▓▒▒█░▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▒▒▒▒▒▒▒░░      ░░▒▒▒▓███▓▓▓▓▓▓▓▓            ",
        "                   ▒▓▓░░░░▒▓▓▓▓▓▓▓▓▓▓▓▓▒░▒▓▓▓▓▒░        ░▒▒▒▒▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓░           ",
        "                   ▒▓▓░░░░▒▓▓▓▓▓▓▓▓▓▓▒░▓▓░▒▓▓▒▒      ░░▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▓▓██▓▓▓            ",
        "                   ▒▓▓░░░░▒▓▓▓▓▓▓▓▓▓▓░░░░░▒▓▓▒░     ▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▓████▒            ",
        "                  ░▒▓▓▒░▒▒▓▓▓▓▓▓▓▓▓▓▒░░░░░▒▓▒▒    ░▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▓▓▓▓▓▓░            ",
        "               ▒▓█▒▒▓▓▓▓▓▓▓▓▓▒▒▓▓▓▓▓▒░░░░▒▓▒▒▒    ░▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▓▓▓▓▓░            ",
        "             ▒▓████▓▒▒▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▒▒▒▒▓▒▒▓▓▓▓░ ▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▓▒▒▒▓▒             ",
        "             ▒██████▓▒▒▒▓▓▓▓▓▓▒▒▒▒▒▓▓▓▓▓▒▒▒▒▓▓▓█▓░▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒░             ",
        "            ░█████████▓▒▒▒▒▓▓▓▓▓▓▓▓▓▒▒▒▒▒▒▒▓▓▓▓▓▓▓▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒░             ",
        "            ▒█████████████▓▒▒▒▒▒▒▒▒▒▒▒▒▒▓▓▓▓▓▓▓▓▓▓▒░▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒░              ",
        "            ▓▓██████████▓████▓▓▓▓▓▓▓▓▓▓▓▒▓▓▓▓▓▓▓▓▓▓▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒░               ",
        "            ░▒▓███▓████▓█████████▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒░░                ",
        "             ░▒▓▓█▓████████████████▓▓▓▓▓▓▓▓▓▓▓▓▓▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒░                  ",
        "               ░▒▓▒███▓█████████████▓▓▒▓▓▓▓▓▓▓▓▓▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒░░                    ",
        "                  ░▓█▓▓▓████████████▓▓▒▓▓▒▓▓▓▓▓▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒░░░▒▒▒░░░                         ",
        "                   ▒▓▓▓▓▓▓█████████▓▓▓▓▓▒▓▓▓▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒░                                 ",
        "                     ▒▓▓▓▓▓▓▓▓▓█▓▓▓▓▓▒▓▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒░                                 ",
        "                     ░▒▒▒▒▓▓▓▓▓▓▓▓▓▓▓▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒░                                 ",
        "                      ▒▒▒▒▒▓█▓▓▓▓▒▒▒▒▒▒▒▒▒░░▒░░▓▓▓▓▓▓▓▒▒                                  ",
        "                      ░▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒░▒▒▒▒░ ░▓▓▓▓▓▓▓▒                                  ",
        "                       ▒▒▒▒▒▒▒▒▒▓▓▒▒▒▒▒▒▒▒▒▒▒░ ░▒▓▓▓▓▓▓▒                                  ",
        "                       ░▓▓▓▓▓▓▒▓▓▓▓▓▓▓▒▒▒▒▒░   ▒▓▓▓▓▓▓▒░                                  ",
        "                        ▒▓▓▓▓▓▒▓▓▓▓▓▓▓▒▒▒▒░   ░▒▓▓▓▓▓▓░                                   ",
        "                       ░▓▓▓▓▓▓▒▓▓▓▓▓▓▓▒▒▒░   ▒▓▒▓▓▓▓▓░                                    ",
        "                      ░▒▓▓▓▓▓▒▓▓▓▓▓▓▓░       ░▒▒▓▒▓▒░                                     ",
        "                         ░░▒▒▒▒▓▓▓▓▓░                                                     ",
        "                              ░▒▒▒▒▒░                                                     ",
        NULL
    };


    for (int i = 0; osArt[i] != NULL; ++i) {
        kprintf(osArt[i]);
        kprintf("\n");
    }

    for (int i = 0; osTitle[i] != NULL; ++i) {
        kprintf(osTitle[i]);
        kprintf("\n");
    }
}

void kprintf(const char *str) {
    flanterm_write(ft_ctx, str, strlen(str));
}
